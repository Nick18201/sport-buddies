<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- meta tag Ã  modifier en temps voulu -->
  <% content_for :meta_title, "#{@event.name} is on #{DEFAULT_META["meta_product_name"]}" %>
  <%# <% content_for :meta_description, @event.description %>
  <%# <% content_for :meta_image, cl_image_path(@event.photo.path) %>
</head>
<body class="show-body-background">
  <div class="main-show">
    <div class="card-show-infos">
      <%= link_to "Voir d'autres activitÃ©s", events_path, class: "backlink-show"  %>
      <h1><%= @event.name %></h1>
      <div class="card-event-description">
        <div class="event-owner-infos">
          <div class="owner-avatar">
            <%= cl_image_tag @event.owner.avatar.key, widht:  100, height: 100, crop: :fill  %>
            <p>OrganisÃ© par <strong> <%= @event.owner.first_name.capitalize %> <%= @event.owner.last_name.capitalize %></strong></p>
          </div>
          <div class="event-owner-level-expected" >
            <% if  @event.expected_level == "dÃ©butant" %>
              <p> <%= @event.expected_level.capitalize %></p>
              <h3><i class="fas fa-medal gold-color"></i></h3>
            <% elsif @event.expected_level == "intermÃ©diaire" %>
              <p> <%= @event.expected_level.capitalize %></p>
              <h3><i class="fas fa-medal gold-color"></i></h3>
              <h3><i class="fas fa-medal gold-color"></i></h3>
            <% elsif @event.expected_level == "confirmÃ©" %>
              <p> <%= @event.expected_level.capitalize %></p>
              <h3><i class="fas fa-medal gold-color"></i></h3>
              <h3><i class="fas fa-medal gold-color"></i></h3>
              <h3><i class="fas fa-medal gold-color"></i></h3>
            <% end %>
          </div>
        </div>

        <div class="card-event-date">
            <h2><i class="far fa-calendar-alt"></i> <strong> <%= @event.starts_at.strftime(" %d/%m") %> </strong></h2>
            <h2 class="gray-separator">|</h2>
            <h2><i class="fas fa-stopwatch"></i> <%= @event.starts_at.strftime("%HH") %> </h2>

          <h2 class="gray-separator">|</h2>
            <% if @event.expected_participants_count.present? %>
              <h2><%= @event.participations.count %> / <%= @event.expected_participants_count %> <i class="fas fa-user-friends"></i></h2>
            <% else %>
              <h3> Aucune limite de buddies</h3>
            <% end %>
        </div>
        <p><%= @event.description %></p>

        <div class="cta-show">

          <% @users_participating = @event.participations.map { |participation| participation[:user_id] } %>
          <% if @users_participating.include?(current_user) %>
              <%= link_to "DÃ©jÃ  inscris", profile_path(current_user), class: "btn-show-buddies" %>

              <%= link_to "J'invite mes buddies", profile_path(current_user), class: "btn-show-buddies"  %>
            <% elsif @event.expected_participants_count == @event.participations.count %>
              <%= link_to "Ã©vÃ¨nement complet ðŸ’ª", events_path, class: "btn-show-buddies" %>
            <% else %>
              <%= link_to "Je m'inscris", event_participations_path(@event), class: "btn-show-participate", method: :post %>

              <%= link_to "J'invite mes buddies", profile_path(current_user), class: "btn-show-buddies"  %> 
          <% end %>
        </div>
      </div>
    <div class="event-show-chat">
      <h3>Conversations</h3>
      <div class="message_to_send">
        <% if @users_participating.include?(current_user) %>
          <div>
          <%= simple_form_for [ @event, @message ], remote: true do |f| %>
            <%= f.input_field :content, label: false, placeholder: "Tape ton message ici #{@user.first_name.capitalize}", class: "field-message-content" %>
          </div>
          <div>
            <%= f.submit "Envoyer", class: "btn-show-participate" %>
          </div>
        <% end %>
        <% else %>
          <p class="unsuscribed-field-message-content"> Tu dois Ãªtre inscrit pour participer Ã  la conversation </p>

        <% end %>
      </div>
        <% @messages.each do |message| %>
      <div class="event-message">
        <div class="messages-avatar">
          <%= cl_image_tag message.user.avatar.key, widht:  100, height: 100, crop: :fill  %>
        </div>
        <div class="message-content">
          <p class="message-user"> <%= message.user.first_name.capitalize %> <%= message.user.last_name.capitalize %> <small><%= message.created_at.strftime(" %d/%m Ã  %HH%Mm") %></small></p>
          <p><%= message.content %></p>
        </div>
      </div>
        <% end %>
    </div>

    </div>

    <div class="map-show">
      <div id="map"
          style="width: 100%; height: 100vh;"
          data-markers="<%= @markers.to_json %>"
          data-mapbox-api-key="<%= ENV['MAPBOX_API_KEY'] %>">>
      </div>
    </div>
  </div>

</body>
</html>
